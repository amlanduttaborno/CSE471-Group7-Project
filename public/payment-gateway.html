<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway - TailorCraft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .payment-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .payment-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 800px;
            width: 100%;
        }
        
        .payment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .payment-body {
            padding: 40px;
        }
        
        .order-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .payment-method.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .payment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .bkash-color { color: #e2136e; }
        .nagad-color { color: #f47820; }
        .card-color { color: #007bff; }
        
        .payment-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        
        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .back-btn {
            background: transparent;
            border: 2px solid #6c757d;
            color: #6c757d;
            border-radius: 10px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: #6c757d;
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            text-align: center;
        }
        
        .spinner {
            font-size: 3rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader">
            <i class="fas fa-spinner spinner"></i>
            <h4 class="mt-3">Processing Payment...</h4>
            <p class="text-muted">Please wait while we redirect you to the payment gateway</p>
        </div>
    </div>

    <div class="payment-container">
        <div class="payment-card">
            <div class="payment-header">
                <h2><i class="fas fa-credit-card me-2"></i>Payment Gateway</h2>
                <p class="mb-0">Choose your preferred payment method</p>
            </div>
            
            <div class="payment-body">
                <!-- Order Summary -->
                <div class="order-summary">
                    <h5 class="mb-3"><i class="fas fa-receipt me-2"></i>Order Summary</h5>
                    <div id="orderDetails">
                        <!-- Order details will be populated here -->
                    </div>
                </div>
                
                <!-- Payment Methods -->
                <h5 class="mb-4"><i class="fas fa-wallet me-2"></i>Select Payment Method</h5>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="payment-method text-center" data-method="bkash" onclick="selectPaymentMethod('bkash')">
                            <div class="payment-icon bkash-color">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <h6>bKash</h6>
                            <small class="text-muted">Mobile Payment</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="payment-method text-center" data-method="nagad" onclick="selectPaymentMethod('nagad')">
                            <div class="payment-icon nagad-color">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <h6>Nagad</h6>
                            <small class="text-muted">Mobile Payment</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="payment-method text-center" data-method="card" onclick="selectPaymentMethod('card')">
                            <div class="payment-icon card-color">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <h6>Card Payment</h6>
                            <small class="text-muted">Visa, MasterCard</small>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Type Selection -->
                <div class="mt-4">
                    <h6><i class="fas fa-calculator me-2"></i>Payment Type</h6>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentType" id="advancePayment" value="advance" checked>
                                <label class="form-check-label" for="advancePayment">
                                    <strong>Advance Payment (40%)</strong>
                                    <br><small class="text-muted">Pay 40% now, rest on delivery</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentType" id="fullPayment" value="full">
                                <label class="form-check-label" for="fullPayment">
                                    <strong>Full Payment (100%)</strong>
                                    <br><small class="text-muted">Pay complete amount now</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Amount Display -->
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="row">
                        <div class="col-6">
                            <strong>Total Order Amount:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="totalAmount">৳ 0</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>Payment Amount:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="paymentAmount" class="text-primary fw-bold">৳ 0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-4 d-flex gap-3">
                    <button type="button" class="btn back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Order
                    </button>
                    <button type="button" class="btn payment-btn flex-fill" id="proceedPayment" onclick="proceedToPayment()" disabled>
                        <i class="fas fa-lock me-2"></i>Proceed to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedPaymentMethod = null;
        let orderData = null;
        
        // Load order data from URL parameters or localStorage
        window.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            updatePaymentAmount();
            
            // Listen for payment type changes
            document.querySelectorAll('input[name="paymentType"]').forEach(radio => {
                radio.addEventListener('change', updatePaymentAmount);
            });
        });
        
        function loadOrderData() {
            // Get order data from localStorage (set by the order form)
            const storedOrderData = localStorage.getItem('pendingOrder');
            if (storedOrderData) {
                orderData = JSON.parse(storedOrderData);
                displayOrderSummary(orderData);
            } else {
                // Redirect back if no order data
                alert('No order data found. Redirecting back to order form.');
                window.location.href = '/customer-dashboard.html#order';
            }
        }
        
        function displayOrderSummary(data) {
            const orderDetailsDiv = document.getElementById('orderDetails');
            const tailorDisplayName = data.tailorName && data.shopName && data.shopName !== 'Not specified' 
                ? `${data.tailorName} (${data.shopName})` 
                : data.tailorName || 'Unknown Tailor';
                
            orderDetailsDiv.innerHTML = `
                <div class="row mb-2">
                    <div class="col-6"><strong>Tailor:</strong></div>
                    <div class="col-6">${tailorDisplayName}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6"><strong>Garment Type:</strong></div>
                    <div class="col-6">${data.garmentType || 'Not specified'}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6"><strong>Fabric:</strong></div>
                    <div class="col-6">${data.fabricDetails.provider === 'tailor' ? 'Provided by Tailor' : 'Customer Provided'}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6"><strong>Expected Delivery:</strong></div>
                    <div class="col-6">${new Date(data.expectedDeliveryDate).toLocaleDateString()}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>Estimated Price:</strong></div>
                    <div class="col-6"><strong>৳ ${data.estimatedPrice || 1500}</strong></div>
                </div>
            `;
        }
        
        function selectPaymentMethod(method) {
            // Remove previous selection
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked method
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            selectedPaymentMethod = method;
            
            // Enable proceed button
            document.getElementById('proceedPayment').disabled = false;
        }
        
        function updatePaymentAmount() {
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            const totalAmount = orderData ? (orderData.estimatedPrice || 1500) : 1500;
            const paymentAmount = paymentType === 'advance' ? totalAmount * 0.4 : totalAmount;
            
            document.getElementById('totalAmount').textContent = `৳ ${totalAmount}`;
            document.getElementById('paymentAmount').textContent = `৳ ${paymentAmount}`;
        }
        
        function goBack() {
            window.history.back();
        }
        
        async function proceedToPayment() {
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }
            
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
                
                // First create the order
                const token = localStorage.getItem('token');
                console.log('Creating order with data:', orderData);
                console.log('Using token:', token ? 'Token exists' : 'No token found');
                
                if (!token) {
                    console.error('❌ No authentication token found');
                    alert('Please log in to place an order');
                    window.location.href = '/customer-auth.html';
                    return;
                }
                
                // Ensure all required fields are present
                const orderPayload = {
                    tailorId: orderData.tailorId,
                    measurements: orderData.measurements,
                    fabricDetails: orderData.fabricDetails,
                    garmentType: orderData.garmentType,
                    expectedDeliveryDate: orderData.expectedDeliveryDate,
                    specialInstructions: orderData.specialInstructions || '',
                    saveMeasurements: orderData.saveMeasurements || false,
                    estimatedPrice: orderData.estimatedPrice || 1500
                };
                
                console.log('Order payload being sent:', orderPayload);
                
                const orderResponse = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderPayload)
                });
                
                console.log('Order response status:', orderResponse.status);
                console.log('Order response ok:', orderResponse.ok);
                
                if (!orderResponse.ok) {
                    const errorText = await orderResponse.text();
                    console.error('❌ Order creation failed:', errorText);
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (orderResponse.status === 401) {
                            console.error('❌ Authentication failed:', errorJson.message);
                            alert('Your session has expired. Please log in again.');
                            localStorage.removeItem('token');
                            localStorage.removeItem('userType');
                            window.location.href = '/customer-auth.html';
                            return;
                        }
                        
                        // Hide loading and show detailed error
                        document.getElementById('loadingOverlay').style.display = 'none';
                        alert(`Order validation failed: ${errorJson.message}\n\nPlease check your order details and try again.`);
                        return;
                        
                    } catch (e) {
                        // Hide loading and show generic error
                        document.getElementById('loadingOverlay').style.display = 'none';
                        alert(`Server error: ${orderResponse.status}\n\nPlease try again or contact support if the problem persists.`);
                        return;
                    }
                }
                
                const orderResult = await orderResponse.json();
                console.log('Order result:', orderResult);
                
                if (orderResult.status !== 'success') {
                    console.error('Order creation failed:', orderResult);
                    throw new Error(orderResult.message || 'Failed to create order');
                }
                
                // Store order details for payment success page
                const orderDetails = {
                    orderId: orderResult.data.orderId,
                    tailorName: orderData.tailorName,
                    shopName: orderData.shopName,
                    garmentType: orderData.garmentType,
                    fabricDetails: orderData.fabricDetails,
                    measurements: orderData.measurements,
                    specialInstructions: orderData.specialInstructions,
                    expectedDeliveryDate: orderData.expectedDeliveryDate,
                    estimatedPrice: orderData.estimatedPrice,
                    paymentType: paymentType,
                    paymentMethod: selectedPaymentMethod,
                    paymentAmount: paymentType === 'advance' ? orderData.estimatedPrice * 0.4 : orderData.estimatedPrice
                };
                
                localStorage.setItem('completedOrderDetails', JSON.stringify(orderDetails));
                
                // For demo purposes, simulate payment processing
                // In production, this would redirect to actual payment gateway
                console.log('Simulating payment processing...');
                
                // Simulate payment delay
                setTimeout(async () => {
                    try {
                        // Create payment record
                        const paymentData = {
                            orderId: orderResult.data.orderId,
                            amount: orderDetails.paymentAmount,
                            paymentType: paymentType,
                            paymentMethod: selectedPaymentMethod,
                            status: 'completed',
                            transactionId: 'TXN' + Date.now() + Math.random().toString(36).substr(2, 9)
                        };
                        
                        const paymentResponse = await fetch('/api/payment/complete', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(paymentData)
                        });
                        
                        if (paymentResponse.ok) {
                            const paymentResult = await paymentResponse.json();
                            console.log('Payment completed:', paymentResult);
                            
                            // Clear the pending order data
                            localStorage.removeItem('pendingOrder');
                            
                            // Redirect to success page
                            window.location.href = '/payment-success.html';
                        } else {
                            throw new Error('Payment processing failed');
                        }
                    } catch (paymentError) {
                        console.error('Payment processing error:', paymentError);
                        window.location.href = '/payment-failed.html';
                    }
                }, 3000); // 3 second delay to simulate processing
                
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Payment failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
